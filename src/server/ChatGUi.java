package server;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import javax.swing.BoxLayout;
import javax.swing.JButton;
import javax.swing.JScrollPane;
import javax.swing.JTextField;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import javax.swing.JFileChooser;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.ScrollPaneConstants;

/**
 *
 * @author taioli Francesco rappresenta la classe per inviare , ricevere i
 * messaggi
 */
public class ChatGUi extends javax.swing.JFrame {

    /**
     * Creates new form IndixisGui
     */
    public ChatGUi(String username, String password) {
        this.username = username;
        this.password = password;
        initComponents();
        registrazione(username, password);
        inizialize();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        title = new javax.swing.JPanel();
        user = new javax.swing.JLabel();
        notifyImage = new javax.swing.JLabel();
        jSeparator1 = new javax.swing.JSeparator();
        eliminareDebug = new javax.swing.JButton();
        menu = new javax.swing.JPanel();
        jSeparator2 = new javax.swing.JSeparator();
        friend = new javax.swing.JPanel();
        tab = new javax.swing.JTabbedPane();
        jScrollPane2 = new javax.swing.JScrollPane();
        messageText = new javax.swing.JTextPane();
        sendButton = new javax.swing.JButton();
        sendFile = new javax.swing.JButton();

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 100, Short.MAX_VALUE)
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 100, Short.MAX_VALUE)
        );

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setBackground(new java.awt.Color(100, 181, 246));

        title.setBackground(new java.awt.Color(100, 181, 246));

        user.setFont(new java.awt.Font("Lucida Sans Unicode", 0, 24)); // NOI18N

        notifyImage.setIcon(new javax.swing.ImageIcon(getClass().getResource("/indixis/img/notify.png"))); // NOI18N

        jSeparator1.setOrientation(javax.swing.SwingConstants.VERTICAL);

        eliminareDebug.setText("jButton1");
        eliminareDebug.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                eliminareDebugActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout titleLayout = new javax.swing.GroupLayout(title);
        title.setLayout(titleLayout);
        titleLayout.setHorizontalGroup(
            titleLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(titleLayout.createSequentialGroup()
                .addGap(104, 104, 104)
                .addComponent(user, javax.swing.GroupLayout.PREFERRED_SIZE, 288, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(36, 36, 36)
                .addComponent(eliminareDebug)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 161, Short.MAX_VALUE)
                .addComponent(jSeparator1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(notifyImage)
                .addContainerGap())
        );
        titleLayout.setVerticalGroup(
            titleLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(titleLayout.createSequentialGroup()
                .addComponent(jSeparator1, javax.swing.GroupLayout.PREFERRED_SIZE, 79, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
            .addComponent(user, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(titleLayout.createSequentialGroup()
                .addGroup(titleLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(titleLayout.createSequentialGroup()
                        .addGap(19, 19, 19)
                        .addComponent(notifyImage, javax.swing.GroupLayout.PREFERRED_SIZE, 32, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(titleLayout.createSequentialGroup()
                        .addGap(24, 24, 24)
                        .addComponent(eliminareDebug)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        menu.setBackground(new java.awt.Color(100, 181, 246));

        javax.swing.GroupLayout menuLayout = new javax.swing.GroupLayout(menu);
        menu.setLayout(menuLayout);
        menuLayout.setHorizontalGroup(
            menuLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jSeparator2, javax.swing.GroupLayout.Alignment.TRAILING)
        );
        menuLayout.setVerticalGroup(
            menuLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, menuLayout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jSeparator2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        friend.setBackground(new java.awt.Color(255, 102, 51));

        javax.swing.GroupLayout friendLayout = new javax.swing.GroupLayout(friend);
        friend.setLayout(friendLayout);
        friendLayout.setHorizontalGroup(
            friendLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 173, Short.MAX_VALUE)
        );
        friendLayout.setVerticalGroup(
            friendLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 0, Short.MAX_VALUE)
        );

        tab.setBackground(new java.awt.Color(255, 255, 255));
        tab.setForeground(new java.awt.Color(0, 153, 102));
        tab.setTabLayoutPolicy(javax.swing.JTabbedPane.SCROLL_TAB_LAYOUT);
        tab.setAutoscrolls(true);
        tab.setFont(new java.awt.Font("Segoe UI Symbol", 0, 14)); // NOI18N
        tab.setInheritsPopupMenu(true);

        messageText.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                messageTextFocusGained(evt);
            }
        });
        jScrollPane2.setViewportView(messageText);

        sendButton.setText("Registra");
        sendButton.setMaximumSize(new java.awt.Dimension(205, 137));
        sendButton.setMinimumSize(new java.awt.Dimension(205, 137));
        sendButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                sendButtonActionPerformed(evt);
            }
        });

        sendFile.setText("Invia File");
        sendFile.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                sendFileActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(friend, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(menu, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(4, 4, 4)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(tab)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 373, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                    .addComponent(sendButton, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                                    .addComponent(sendFile, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE))
                                .addGap(0, 0, Short.MAX_VALUE)))
                        .addContainerGap())))
            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addComponent(title, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(92, 92, 92)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(friend, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(menu, javax.swing.GroupLayout.PREFERRED_SIZE, 0, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(tab, javax.swing.GroupLayout.PREFERRED_SIZE, 343, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 54, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(sendButton, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                .addComponent(sendFile)))
                        .addGap(0, 6, Short.MAX_VALUE))))
            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(layout.createSequentialGroup()
                    .addComponent(title, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGap(0, 428, Short.MAX_VALUE)))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void sendButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_sendButtonActionPerformed
        if((messageText.getText()).equals("")){
            System.out.println("PRova");
        }
        else{
            String text = messageText.getText();
            JLabel label = new JLabel(text);
            messageText.setText("");
            sendButton.setText("Registra");
            panelMessage.add(label);
            panelMessage.revalidate();
            panelMessage.repaint();

            //aggiungo il messaggio all'array
            String user = "QQQ";
            String destinatario = tab.getTitleAt(0);
            Message message = new Message(user, text, destinatario);
            listaMessaggi.add(message);
        }
    }//GEN-LAST:event_sendButtonActionPerformed

    /**
     * eliminare
     * in prova
     * @param evt 
     */
    private void eliminareDebugActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_eliminareDebugActionPerformed

        System.out.println( notifiche.get("adriana"));
        JLabel k = new JLabel();
        int i = Integer.valueOf((String) notifiche.get("adriana"));
        
        k =  (JLabel)(counterNotifiche.get(i));
       k.setText("4");
        
    }//GEN-LAST:event_eliminareDebugActionPerformed

    private void messageTextFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_messageTextFocusGained
        if(messageText.getText().length() > 0){
            System.out.println("PRova");
            sendButton.setText("Invia");
        }
    }//GEN-LAST:event_messageTextFocusGained

    private void sendFileActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_sendFileActionPerformed
        JFileChooser filechooser = new JFileChooser();
        int returnValue = filechooser.showOpenDialog(null); //del parent maggiore
        if (returnValue == filechooser.APPROVE_OPTION) {
            System.out.println(filechooser.getSelectedFile().getAbsolutePath());
            System.out.println("Invio file in corso");
            Connection.inviaFile(filechooser.getSelectedFile().getAbsolutePath(), tab.getTitleAt(0));
        }
    }//GEN-LAST:event_sendFileActionPerformed

    /**
     * setta il nome dell'utente
     * @param userName 
     */
    public void setUser(String userName){
        user.setText("Bentornato, " + userName);
    }
    
    
    private boolean registrazione(String username, String password) {
        MessageDigest md;

        try {
            md = MessageDigest.getInstance("MD5");
            byte[] passBytes = password.getBytes();
            md.reset();
            StringBuilder sb = new StringBuilder();
            for (int i = 0; i < passBytes.length; i++) {
                sb.append(Integer.toHexString(0xff & passBytes[i]));
            }
            password = sb.toString();
        } catch (NoSuchAlgorithmException ex) {
            System.out.println("Errore creazione hash password");
        }

        Connection prova = new Connection(5555, "127.0.0.1", username, password, "login", this);

        return true;
    }

    public void setFriendsListArray(ArrayList listaAmici) {
        ar = listaAmici;
        amici();

        friend.setLayout(new BoxLayout(friend, BoxLayout.Y_AXIS));
        friend.setVisible(true);
        friend.revalidate();
    }

    public void amici() {
        int x = 0;
        for (int i = 0; i < ar.size(); i++) {
            String text = (String) ar.get(i).toString();
            
            //notifiche
            notifiche.put(text,String.valueOf(i));
            JLabel notify = new JLabel(String.valueOf(i));
//            notify.set
            counterNotifiche.add(notify);
            
            
            JButton button = new JButton((String) ar.get(i).toString());

            button.addActionListener(new ActionListener() {
                public void actionPerformed(ActionEvent ae) {

                    panelMessage.setBackground(Color.white);
                    arrayTab.add(tab);
                    if (x == 0) {
                        tab.addTab(text, scroll);

                    } else {
                        int index = tab.getSelectedIndex();
                        tab.setTitleAt(0, text);
                    }
                    setMessage();
                    System.out.println("--------------------------------------------");
                }
            });
            JPanel p = new JPanel();
            p.setBackground(Color.red);
            p.setMaximumSize(new Dimension(200,30));
            p.add(button);
            p.add(notify);
            friend.add(p);
            System.out.println((String) ar.get(i).toString());
        }
    }

    /**
     * setta i messagi nel panel in corrispondenza dell utente
     */
    public void setMessage() {
        String destinatario = tab.getTitleAt(0);
        panelMessage.removeAll();
        //add your elements
        panelMessage.revalidate();
        panelMessage.repaint();
        for (int i = 0; i < listaMessaggi.size(); i++) {
            if (listaMessaggi.get(i).getDestinatario().equals(destinatario)) {
                //JPanel boxMessage = new JPanel(new FlowLayout(FlowLayout.RIGHT));
                JPanel boxMessage = new JPanel();
                boxMessage.setBackground(Color.red);
                //aggiugnere i bordi rotondi
                boxMessage.setMaximumSize(new Dimension(400, 30));
                boxMessage.setAlignmentX(Component.RIGHT_ALIGNMENT);//0.0
                JLabel message = new JLabel(listaMessaggi.get(i).getMessage());

                boxMessage.add(message);
                // panelMessage.setLayout(new BoxLayout(panelMessage, BoxLayout.Y_AXIS));
                panelMessage.add(boxMessage);
                panelMessage.revalidate();
                panelMessage.repaint();

            }
        }
    }

    public void inizialize() {
        panelMessage.setLayout(new BoxLayout(panelMessage, BoxLayout.Y_AXIS));
        panelMessage.setMaximumSize(new Dimension(600, 600));
        scroll.setViewportView(panelMessage);                                  //add
        //add
        scroll.setPreferredSize(new Dimension(50, 50));
        scroll.getVerticalScrollBar().setUI(new MyScrollBarUI());         //add

    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton eliminareDebug;
    private javax.swing.JPanel friend;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JSeparator jSeparator1;
    private javax.swing.JSeparator jSeparator2;
    private javax.swing.JPanel menu;
    private javax.swing.JTextPane messageText;
    private javax.swing.JLabel notifyImage;
    private javax.swing.JButton sendButton;
    private javax.swing.JButton sendFile;
    private javax.swing.JTabbedPane tab;
    private javax.swing.JPanel title;
    public javax.swing.JLabel user;
    // End of variables declaration//GEN-END:variables
       private ArrayList ar = new ArrayList();
    public ArrayList arrayTab = new ArrayList();
    private String username;
    private String password;
    Connection connection;
    private JPanel panelMessage = new JPanel(new BorderLayout());
    int v = ScrollPaneConstants.VERTICAL_SCROLLBAR_ALWAYS;
    int h = ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED;
    JScrollPane scroll = new JScrollPane(panelMessage, v, h);
    private List<Message> listaMessaggi = new ArrayList();
    LinkedHashMap  notifiche = new LinkedHashMap ();
    private List <JLabel> counterNotifiche = new ArrayList();
}
